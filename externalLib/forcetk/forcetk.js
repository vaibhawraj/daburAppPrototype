define(["jquery","core/Logger"],function(a,b){var c={};if(void 0===c&&(c={}),void 0===c.Client){c.Client=function(a,b,c){"use strict";this.clientId=a,this.loginUrl=b||"https://login.salesforce.com/",void 0===c||null===c?("file:"===location.protocol||"ms-appx:"===location.protocol?this.proxyUrl=null:this.proxyUrl=location.protocol+"//"+location.hostname+"/services/proxy",this.authzHeader="Authorization"):(this.proxyUrl=c,this.authzHeader="X-Authorization"),this.refreshToken=null,this.sessionId=null,this.apiVersion=null,this.visualforce=!1,this.instanceUrl=null,this.asyncAjax=!0},c.Client.prototype.setRefreshToken=function(a){"use strict";this.refreshToken=a},c.Client.prototype.refreshAccessToken=function(c,d){"use strict";var e=this,f=this.loginUrl+"/services/oauth2/token";return b.debug("Forcetk","Refreshing Access Token, Expired Access Token : ",this.sessionId),a.ajax({type:"POST",url:null===this.proxyUrl||this.visualforce?f:this.proxyUrl,cache:!1,processData:!1,data:"grant_type=refresh_token&client_id="+this.clientId+"&refresh_token="+this.refreshToken,success:c,error:d,dataType:"json",beforeSend:function(a){null===e.proxyUrl||this.visualforce||a.setRequestHeader("SalesforceProxy-Endpoint",f)}})},c.Client.prototype.setSessionToken=function(a,b,c){"use strict";if(this.sessionId=a,this.apiVersion=void 0===b||null===b?"v29.0":b,void 0===c||null===c){this.visualforce=!0;var d=location.hostname.split("."),e=null;e=4===d.length&&"my"===d[1]?d[0]+"."+d[1]:3===d.length?d[0]:d[1],this.instanceUrl="https://"+e+".salesforce.com"}else this.instanceUrl=c},c.Client.prototype.ajax=function(c,d,e,f,g,h){"use strict";var i=this,j=(this.visualforce?"":this.instanceUrl)+"/services/data"+c;return a.ajax({type:f||"GET",async:this.asyncAjax,url:null===this.proxyUrl||this.visualforce?j:this.proxyUrl,contentType:"DELETE"===f?null:"application/json",cache:!1,processData:!1,data:g,success:d,error:!this.refreshToken||h?e:function(a,h,j){401===a.status?i.refreshAccessToken(function(a){i.setSessionToken(a.access_token,null,a.instance_url),i.ajax(c,d,e,f,g,!0)},function(){b.error("Forcetk","Failed to refresh access token",JSON.stringify(arguments)),e.apply(this,arguments)}):e(a,h,j)},dataType:"json",beforeSend:function(a){null===i.proxyUrl||i.visualforce||a.setRequestHeader("SalesforceProxy-Endpoint",j),a.setRequestHeader(i.authzHeader,"Bearer "+i.sessionId),a.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/"+i.apiVersion)}})},c.Client.prototype.getChatterFile=function(a,b,c,d,e){"use strict";var f=this,g=(this.visualforce?"":this.instanceUrl)+a,h=new XMLHttpRequest;h.open("GET",null===this.proxyUrl||this.visualforce?g:this.proxyUrl,!0),h.responseType="arraybuffer",h.setRequestHeader(this.authzHeader,"Bearer "+this.sessionId),h.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/"+this.apiVersion),null===this.proxyUrl||this.visualforce||h.setRequestHeader("SalesforceProxy-Endpoint",g),h.onreadystatechange=function(){if(4===h.readyState)if(200===h.status)try{c(h.response)}catch(a){alert("Error reading the response: "+a.toString())}else 401!==h.status||e?d(h,h.statusText,h.response):f.refreshAccessToken(function(e){f.setSessionToken(e.access_token,null,e.instance_url),f.getChatterFile(a,b,c,d,!0)},d)},h.send()};var d=function(){"use strict";var a,b="";for(a=0;a<4;a+=1)b+=(Math.random().toString(16)+"000000000").substr(2,8);return b};c.Client.prototype.blob=function(a,b,c,e,f,g,h,i){"use strict";var j=this,k=(this.visualforce?"":this.instanceUrl)+"/services/data"+a,l=d(),m=new Blob(["--boundary_"+l+'\nContent-Disposition: form-data; name="entity_content";\nContent-Type: application/json\n\n'+JSON.stringify(b)+"\n\n--boundary_"+l+'\nContent-Type: application/octet-stream\nContent-Disposition: form-data; name="'+e+'"; filename="'+c+'"\n\n',f,"\n\n--boundary_"+l+"--"],{type:'multipart/form-data; boundary="boundary_'+l+'"'}),n=new XMLHttpRequest;return n.open("POST",null===this.proxyUrl||this.visualforce?k:this.proxyUrl,this.asyncAjax),n.setRequestHeader("Accept","application/json"),n.setRequestHeader(this.authzHeader,"Bearer "+this.sessionId),n.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/"+this.apiVersion),n.setRequestHeader("Content-Type",'multipart/form-data; boundary="boundary_'+l+'"'),null===this.proxyUrl||this.visualforce||n.setRequestHeader("SalesforceProxy-Endpoint",k),this.asyncAjax&&(n.onreadystatechange=function(){4===n.readyState&&(n.status>=200&&n.status<300?g(n.response?JSON.parse(n.response):null):401!==n.status||i?h(n,n.statusText,n.response):j.refreshAccessToken(function(d){j.setSessionToken(d.access_token,null,d.instance_url),j.blob(a,b,c,e,f,g,h,!0)},h))}),n.send(m),this.asyncAjax?null:JSON.parse(n.response)},c.Client.prototype.createBlob=function(a,b,c,d,e,f,g,h){"use strict";return this.blob("/"+this.apiVersion+"/sobjects/"+a+"/",b,c,d,e,f,g,h)},c.Client.prototype.updateBlob=function(a,b,c,d,e,f,g,h,i){"use strict";return this.blob("/"+this.apiVersion+"/sobjects/"+a+"/"+b+"?_HttpMethod=PATCH",c,d,e,f,g,h,i)},c.Client.prototype.apexrest=function(b,c,d,e,f,g,h){"use strict";var i=this,j=this.instanceUrl+"/services/apexrest"+b;return e=e||"GET","GET"===e?this.proxyUrl&&f&&("string"!=typeof f&&(f=a.param(f)),j+="?"+f,f=null):f&&"string"!=typeof f&&(f=JSON.stringify(f)),a.ajax({type:e,async:this.asyncAjax,url:this.proxyUrl||j,contentType:"application/json",cache:!1,processData:!1,data:f,success:c,error:!this.refreshToken||h?d:function(a,h,j){401===a.status?i.refreshAccessToken(function(a){i.setSessionToken(a.access_token,null,a.instance_url),i.apexrest(b,c,d,e,f,g,!0)},d):d(a,h,j)},dataType:"json",beforeSend:function(a){var b;null!==i.proxyUrl&&a.setRequestHeader("SalesforceProxy-Endpoint",j),null===g&&(g={});for(b in g)g.hasOwnProperty(b)&&a.setRequestHeader(b,g[b]);a.setRequestHeader(i.authzHeader,"Bearer "+i.sessionId),a.setRequestHeader("X-User-Agent","salesforce-toolkit-rest-javascript/"+i.apiVersion)}})},c.Client.prototype.versions=function(a,b){"use strict";return this.ajax("/",a,b)},c.Client.prototype.resources=function(a,b){"use strict";return this.ajax("/"+this.apiVersion+"/",a,b)},c.Client.prototype.describeGlobal=function(a,b){"use strict";return this.ajax("/"+this.apiVersion+"/sobjects/",a,b)},c.Client.prototype.metadata=function(a,b,c){"use strict";return this.ajax("/"+this.apiVersion+"/sobjects/"+a+"/",b,c)},c.Client.prototype.describe=function(a,b,c){"use strict";return this.ajax("/"+this.apiVersion+"/sobjects/"+a+"/describe/",b,c)},c.Client.prototype.create=function(a,b,c,d){"use strict";return this.ajax("/"+this.apiVersion+"/sobjects/"+a+"/",c,d,"POST",JSON.stringify(b))},c.Client.prototype.retrieve=function(a,b,c,d,e){"use strict";4===arguments.length&&(e=d,d=c,c=null);var f=c?"?fields="+c:"";return this.ajax("/"+this.apiVersion+"/sobjects/"+a+"/"+b+f,d,e)},c.Client.prototype.upsert=function(a,b,c,d,e,f){"use strict";return this.ajax("/"+this.apiVersion+"/sobjects/"+a+"/"+b+"/"+c+"?_HttpMethod=PATCH",e,f,"POST",JSON.stringify(d))},c.Client.prototype.update=function(a,b,c,d,e){"use strict";return this.ajax("/"+this.apiVersion+"/sobjects/"+a+"/"+b+"?_HttpMethod=PATCH",d,e,"POST",JSON.stringify(c))},c.Client.prototype.del=function(a,b,c,d){"use strict";return this.ajax("/"+this.apiVersion+"/sobjects/"+a+"/"+b,c,d,"DELETE")},c.Client.prototype.query=function(a,b,c){"use strict";return this.ajax("/"+this.apiVersion+"/query?q="+encodeURIComponent(a),b,c)},c.Client.prototype.queryMore=function(a,b,c){"use strict";var d="services/data",e=a.indexOf(d);return e>-1&&(a=a.substr(e+d.length)),this.ajax(a,b,c)},c.Client.prototype.search=function(a,b,c){"use strict";return this.ajax("/"+this.apiVersion+"/search?q="+encodeURIComponent(a),b,c)}}return c});